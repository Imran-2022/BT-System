<!-- Bus Details Loading State -->
<div *ngIf="isLoading"
    class="flex flex-col items-center justify-center py-12 px-6 bg-[#f5f7f9] min-h-screen rounded-sm">

    <!-- Spinner -->
    <div class="w-12 h-12 mb-6 border-4 border-gray-200 border-t-yellow-500 rounded-full animate-spin"></div>

    <!-- Loading Message -->
    <div class="text-center max-w-md">
        <p class="text-lg font-semibold text-gray-600 mb-2">Wish you a safe Journey!</p>
        <p class="text-md text-gray-700">Please wait while we fetch Details for your Desired Bus.</p>
    </div>
</div>


<!-- Error State -->
<div *ngIf="error" class="bg-[#f5f7f9] border-l-4 border-red-500 text-red-700 p-4 m-16" role="alert">
    <p class="p-4 mb-4 text-red-700 bg-red-100 border border-red-200 rounded-lg">Error {{ error }}</p>
    <p class="text-gray-600">Something went wrong while fetching the bus details. Please try again.</p>
</div>


<!-- Bus Details & Booking Section -->
<div *ngIf="busDetails && !isLoading" class="container mx-auto p-4">

    <!-- Bus Information Card -->
    <app-bus-info-card  *ngIf="!isBooked && busDetails"
        [busDetails]="busDetails"
        [currentDate]="currentDate"
        >
    </app-bus-info-card>


    <div class="flex justify-center items-start min-h-screen pb-4">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-6 md:gap-12 md:p-6 max-w-6xl w-full ">

            <!-- Booking Confirmation Overlay -->
            <div *ngIf="isBooked" class="fixed inset-0 flex items-center justify-center bg-gray-300 bg-opacity-50 z-50">
                <div
                    class="bg-[#f5f7f9] p-6 md:p-10 rounded shadow text-center max-w-sm md:max-w-lg w-11/12 mx-auto md:w-full transform transition-all duration-300 scale-100">
                    <div class="text-4xl text-green-500 mb-3">&#10004;</div>
                    <h2 class="text-2xl md:text-3xl font-bold mb-2 text-gray-800">Booking Confirmed!</h2>
                    <p class="text-lg text-gray-600 mb-6">Your ticket has been successfully booked.</p>

                    <button (click)="resetBooking()"
                        class="cursor-pointer py-2 px-6 text-base font-semibold rounded-md bg-indigo-600 text-white hover:bg-indigo-700 transition duration-150">
                        Book Another Ticket
                    </button>
                </div>
            </div>

            <!-- Main Booking Interface -->
            <ng-container *ngIf="!isBooked">

                <!-- Seat Selection Section -->
                <div class="md:col-span-6 space-y-6">
                    <app-bus-seat-selector
                        [seatRows]="seatRows"
                        [getSeatClass]="getSeatClass.bind(this)"
                        [toggleSeat]="toggleSeat.bind(this)">
                    </app-bus-seat-selector>

                </div>

                <!-- Passenger & Booking Summary -->
                <div class="md:col-span-6 space-y-6">

                    <!-- Traveler Information -->
                    <div class="bg-white p-5 rounded border border-gray-200">
                        <h2 class="text-lg font-bold mb-3 text-gray-800">Traveler Contact</h2>

                        <!-- Boarding Point -->
                        <div class="mb-2">
                            <label class="block text-sm font-medium text-gray-700">Boarding Point</label>
                            <select [(ngModel)]="boardingPointId" required
                                class="mt-1 block w-full border border-gray-300 p-1.5 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                                <option *ngFor="let point of busDetails.boardingPoints" [value]="point.pointId">
                                    {{ point.locationName }} ({{ point.time | slice:0:5 }})
                                </option>
                            </select>
                        </div>

                        <!-- Dropping Point -->
                        <div class="mb-2">
                            <label class="block text-sm font-medium text-gray-700">Dropping Point</label>
                            <select [(ngModel)]="droppingPointId" required
                                class="mt-1 block w-full border border-gray-300 p-1.5 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                                <option *ngFor="let point of busDetails.droppingPoints" [value]="point.pointId">
                                    {{ point.locationName }} ({{ point.time | slice:0:5 }})
                                </option>
                            </select>
                        </div>

                        <!-- Mobile Number -->
                        <div class="mb-2">
                            <label class="block text-sm font-medium text-gray-700">Mobile Number (11 Digits)</label>
                            <input type="tel" [(ngModel)]="mobileNumber" required pattern="^[0-9]{11}$" minlength="11"
                                maxlength="11" placeholder="e.g., 01XXXXXXXXX" #mobileInput="ngModel"
                                class="mt-1 block w-full border border-gray-300 rounded p-1.5 text-sm">
                            <div *ngIf="mobileInput.invalid && mobileInput.touched" class="text-red-600 text-xs mt-1">
                                <span *ngIf="mobileInput.errors?.['required']">Mobile number is required.</span>
                                <span *ngIf="mobileInput.errors?.['pattern']">Must be exactly 11 digits.</span>
                            </div>
                        </div>

                        <!-- Passenger Names -->
                        <h2 *ngIf="selectedSeats.length > 0" class="block text-sm font-medium text-gray-700 mb-2">
                            Passenger Names</h2>
                        <div *ngFor="let seat of selectedSeats" class="flex items-center gap-2 mb-2">
                            <span class="font-medium text-indigo-700 w-12 text-sm shrink-0 whitespace-nowrap">Seat {{ seat.seatNumber
                                }}</span>
                            <input type="text" [value]="seat.passengerName"
                                (input)="updatePassengerName(seat.seatNumber, $event.target.value)"
                                placeholder="Enter Name"
                                class="grow text-sm border border-gray-300 rounded p-1 px-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>

                    <!-- Booking Summary -->
                    <div class="bg-white p-5 rounded border border-gray-200">
                        <h2 class="text-lg font-bold mb-3 text-gray-800">Booking Summary</h2>

                        <div class="flex justify-between py-1 text-gray-700 text-sm">
                            <span>Seats Selected:</span>
                            <span class="font-semibold">{{ selectedSeats.length }}</span>
                        </div>

                        <div class="flex justify-between py-2 border-t mt-2 pt-2">
                            <span class="font-bold text-gray-800">Total Payable:</span>
                            <span class="font-extrabold text-red-600">à§³{{ getTotalPrice() | number:'1.2-2' }}</span>
                        </div>

                        <!-- Proceed Button -->
                        <button (click)="proceedToBooking()" [disabled]="isBooking || !isBookingFormValid()"
                            class="w-full mt-4 py-2 text-base font-bold rounded transition duration-150"
                            [ngClass]="isBookingFormValid() ? 'bg-green-500 text-white hover:bg-green-600 hover:cursor-pointer' : 'bg-gray-600 text-white cursor-not-allowed'">

                            <span *ngIf="!isBooking; else bookingLoader">
                                {{ selectedSeats.length > 0 ? 'Proceed to Book (' + selectedSeats.length + ' Seat' +
                                (selectedSeats.length > 1 ? 's' : '') + ')' : 'Select Seats to Book' }}
                            </span>
                            <ng-template #bookingLoader>Processing Booking...</ng-template>
                        </button>
                    </div>
                </div>
            </ng-container>
        </div>
    </div>
</div>